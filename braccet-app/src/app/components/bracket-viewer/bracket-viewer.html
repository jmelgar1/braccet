@if (preview()) {
  <div class="bracket-container">
    <div class="bracket-grid" [style.--rounds]="rounds().length">
      @for (roundData of rounds(); track roundData.round) {
        <div class="round" [attr.data-round]="roundData.round">
          <div class="round-header">{{ getRoundLabel(roundData.round) }}</div>
          <div class="matches-column">
            @for (match of roundData.matches; track match.position) {
              <div class="match-wrapper">
                <div class="match-with-action" [class.no-action]="!showActionArea(match)">
                  <div class="match"
                     [class.bye]="isBye(match)"
                     [class.tbd]="isMatchTBD(match)"
                     [class.forfeit]="isMatchForfeit(match)"
                     [class.completed]="isCompleted(match)">
                    <div class="participant top"
                         [class.bye-slot]="!getParticipant1Display(match) || getParticipant1Display(match) === 'TBD'"
                         [class.forfeited]="isParticipant1Forfeited(match)"
                         [class.winner]="isWinner(match, getParticipant1Id(match))">
                      @if (getSeed1(match)) {
                        <span class="seed">{{ getSeed1(match) }}</span>
                      }
                      <span class="name">{{ getParticipant1Display(match) }}</span>
                      @if (isParticipant1Forfeited(match)) {
                        <span class="forfeit-badge">WD</span>
                      }
                    </div>
                    <div class="participant bottom"
                         [class.bye-slot]="!getParticipant2Display(match) || getParticipant2Display(match) === 'TBD'"
                         [class.forfeited]="isParticipant2Forfeited(match)"
                         [class.winner]="isWinner(match, getParticipant2Id(match))">
                      @if (getSeed2(match)) {
                        <span class="seed">{{ getSeed2(match) }}</span>
                      }
                      <span class="name">{{ getParticipant2Display(match) }}</span>
                      @if (isParticipant2Forfeited(match)) {
                        <span class="forfeit-badge">WD</span>
                      }
                    </div>
                  </div>
                  @if (showActionArea(match)) {
                    <div class="match-action"
                         [class.completed]="isCompleted(match)"
                         [class.bye-action]="isBye(match)">
                      @if (isBye(match)) {
                        <span class="bye-label">BYE</span>
                      } @else if (isCompleted(match)) {
                        <div class="score-display">
                          <div class="score-cell top" [class.winner]="isWinner(match, getParticipant1Id(match))">{{ getParticipant1Score(match) }}</div>
                          <div class="score-cell bottom" [class.winner]="isWinner(match, getParticipant2Id(match))">{{ getParticipant2Score(match) }}</div>
                        </div>
                      } @else {
                        <button class="report-btn" (click)="onReportClick(match, $event)">
                          <img src="edit-match.png" alt="Report score" class="report-icon" />
                        </button>
                      }
                    </div>
                  }
                  @if (!isBye(match) && !isPreview()) {
                    <div class="match-hover-area" [class.completed]="isCompleted(match)">
                      @if (canEditMatch(match)) {
                        <button class="edit-btn" (click)="onEditClick(match, $event)">
                          <img src="/edit-match.png" alt="Edit score" class="edit-icon" />
                        </button>
                      }
                      @if (canReopenMatch(match)) {
                        <button class="reopen-btn" (click)="onReopenClick(match, $event)">
                          <img src="/reopen-match.png" alt="Reopen match" class="reopen-icon" />
                        </button>
                      }
                      <button class="details-btn" (click)="onDetailsClick(match, $event)">
                        <img src="/match-details.png" alt="Match details" class="details-icon" />
                      </button>
                      @if (isCompleted(match) && getSets(match).length > 0) {
                        <div class="sets-display">
                          @for (set of getSets(match); track $index) {
                            <div class="set-column">
                              <div class="set-score top" [class.set-winner]="set.p1 > set.p2">{{ set.p1 }}</div>
                              <div class="set-score bottom" [class.set-winner]="set.p2 > set.p1">{{ set.p2 }}</div>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
                <!-- Connector line to next round -->
                @if (roundData.round < rounds().length) {
                  <div class="connector">
                    <div class="line-h"></div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
} @else {
  <div class="no-bracket">
    <p class="text-gray-500 text-sm">No bracket to display</p>
  </div>
}

<!-- Match Details Modal -->
@if (showDetailsModal && selectedMatch) {
  <div class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Match Details</h3>
        <button class="modal-close" (click)="closeDetailsModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- Matchup Cards -->
        <div class="matchup-container">
          <div class="participant-card" [class.winner]="isWinner(selectedMatch, getParticipant1Id(selectedMatch))">
            <img src="/profile-icon.png" alt="Team logo" class="card-logo" />
            <span class="card-name">{{ getParticipant1Display(selectedMatch) }}</span>
            @if (isCompleted(selectedMatch)) {
              <span class="card-score">{{ getParticipant1Score(selectedMatch) }}</span>
            }
          </div>
          <div class="vs-badge">VS</div>
          <div class="participant-card" [class.winner]="isWinner(selectedMatch, getParticipant2Id(selectedMatch))">
            <img src="/profile-icon.png" alt="Team logo" class="card-logo" />
            <span class="card-name">{{ getParticipant2Display(selectedMatch) }}</span>
            @if (isCompleted(selectedMatch)) {
              <span class="card-score">{{ getParticipant2Score(selectedMatch) }}</span>
            }
          </div>
        </div>

        <!-- Scoreboard -->
        @if (isCompleted(selectedMatch) && getSets(selectedMatch).length > 0) {
          <div class="scoreboard">
            <div class="scoreboard-row" [class.winner]="isWinner(selectedMatch, getParticipant1Id(selectedMatch))">
              <span class="scoreboard-name">{{ getParticipant1Display(selectedMatch) }}</span>
              <div class="scoreboard-sets">
                @for (set of getSets(selectedMatch); track $index) {
                  <span class="scoreboard-set" [class.set-winner]="set.p1 > set.p2">{{ set.p1 }}</span>
                }
              </div>
            </div>
            <div class="scoreboard-row" [class.winner]="isWinner(selectedMatch, getParticipant2Id(selectedMatch))">
              <span class="scoreboard-name">{{ getParticipant2Display(selectedMatch) }}</span>
              <div class="scoreboard-sets">
                @for (set of getSets(selectedMatch); track $index) {
                  <span class="scoreboard-set" [class.set-winner]="set.p2 > set.p1">{{ set.p2 }}</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}
