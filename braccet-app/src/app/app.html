<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">Braccet Test UI</h1>

  <!-- Error -->
  @if (error()) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 flex justify-between items-center">
      <span>{{ error() }}</span>
      <button class="text-red-700 hover:text-red-900 text-xl font-bold" (click)="error.set('')">&times;</button>
    </div>
  }

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Participants Card -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-semibold mb-4 pb-3 border-b border-gray-200">Participants</h2>
      <div class="space-y-4">
        <!-- Add Form -->
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Participant Name</label>
            <input type="text"
                   class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   [ngModel]="newParticipantName()"
                   (ngModelChange)="newParticipantName.set($event)"
                   (keyup.enter)="addParticipant()" />
          </div>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded self-end"
                  (click)="addParticipant()">Add</button>
        </div>

        <!-- Tournament ID -->
        <div class="flex items-center gap-3">
          <span class="text-gray-500">Tournament ID:</span>
          <input type="number"
                 class="w-20 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 [ngModel]="tournamentId()"
                 (ngModelChange)="tournamentId.set($event)" />
        </div>

        <hr class="border-gray-200">

        <!-- Participant List -->
        <div class="text-gray-500 text-sm">{{ participants().length }} participants</div>
        <ul class="divide-y divide-gray-200">
          @for (p of participants(); track p.id) {
            <li class="py-3 flex justify-between items-center">
              <span>
                <span class="inline-block px-2 py-1 text-xs rounded-full bg-gray-200 mr-2">#{{ p.seed }}</span>
                {{ p.name }}
              </span>
              <button class="text-red-600 hover:text-red-700 px-3 py-1" (click)="removeParticipant(p.id)">Remove</button>
            </li>
          } @empty {
            <li class="py-3 text-gray-500">No participants added</li>
          }
        </ul>
      </div>
      <div class="flex gap-2 mt-6 pt-4 border-t border-gray-200">
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                [disabled]="participants().length < 2"
                (click)="generateBracket()">
          Generate Bracket
        </button>
        <button class="text-blue-600 hover:text-blue-700 px-4 py-2" (click)="refreshBracket()">Refresh</button>
        <button class="text-red-600 hover:text-red-700 px-4 py-2" (click)="clearAll()">Clear</button>
      </div>
    </div>

    <!-- Report Result Card -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-semibold mb-4 pb-3 border-b border-gray-200">Report Result</h2>
      @if (selectedMatch(); as match) {
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span>Round {{ match.round }}, Match {{ match.position }}</span>
            <span class="px-2 py-1 text-xs rounded-full bg-gray-200">{{ match.status }}</span>
          </div>

          <hr class="border-gray-200">

          <!-- Scores -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">{{ match.participant1_name || 'TBD' }}</label>
              <input type="number"
                     class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                     [ngModel]="score1()"
                     (ngModelChange)="score1.set($event)" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">{{ match.participant2_name || 'TBD' }}</label>
              <input type="number"
                     class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                     [ngModel]="score2()"
                     (ngModelChange)="score2.set($event)" />
            </div>
          </div>

          @if (match.status === 'ready') {
            <button class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" (click)="startMatch(match)">
              Start Match
            </button>
          }

          <div class="grid grid-cols-2 gap-4">
            @if (match.participant1_id) {
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" (click)="reportResult(match.participant1_id!)">
                {{ match.participant1_name }} Wins
              </button>
            }
            @if (match.participant2_id) {
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" (click)="reportResult(match.participant2_id!)">
                {{ match.participant2_name }} Wins
              </button>
            }
          </div>

          <button class="text-gray-600 hover:text-gray-700 px-4 py-2" (click)="selectedMatch.set(null)">Cancel</button>
        </div>
      } @else {
        <p class="text-gray-500 text-center py-12">
          Click a match below to report its result
        </p>
      }
    </div>
  </div>

  <!-- Bracket -->
  @if (bracket(); as b) {
    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
      <div class="mb-4 pb-3 border-b border-gray-200">
        <h2 class="text-xl font-semibold">Bracket</h2>
        <p class="text-sm text-gray-500 mt-1">
          @if (b.is_complete) {
            <span class="text-green-600">Complete! Champion: {{ b.champion_id }}</span>
          } @else {
            Round {{ b.current_round }} / {{ b.total_rounds }}
          }
        </p>
      </div>
      <div class="flex overflow-x-auto pb-4 gap-6">
        @for (round of getRounds(); track round) {
          <div class="min-w-[220px]">
            <div class="text-gray-500 text-center mb-4">
              @if (round === b.total_rounds) { Finals }
              @else { Round {{ round }} }
            </div>

            @for (match of getMatchesByRound(round); track match.id) {
              <div class="border rounded-lg mb-3 cursor-pointer transition-all"
                   [class.opacity-60]="match.status === 'completed'"
                   [class.border-blue-500]="selectedMatch()?.id === match.id"
                   [class.border-gray-200]="selectedMatch()?.id !== match.id"
                   (click)="selectMatch(match)">
                <div class="p-3">
                  <div class="flex justify-between items-center mb-2">
                    <small class="text-gray-500">Match {{ match.position }}</small>
                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100">{{ match.status }}</span>
                  </div>

                  <!-- Player 1 -->
                  <div class="flex justify-between py-1"
                       [class.text-green-600]="match.winner_id === match.participant1_id">
                    <span>{{ match.participant1_name || 'TBD' }}</span>
                    @if (match.participant1_score != null) {
                      <strong>{{ match.participant1_score }}</strong>
                    }
                  </div>

                  <hr class="border-gray-200 my-1">

                  <!-- Player 2 -->
                  <div class="flex justify-between py-1"
                       [class.text-green-600]="match.winner_id === match.participant2_id">
                    <span>{{ match.participant2_name || 'TBD' }}</span>
                    @if (match.participant2_score != null) {
                      <strong>{{ match.participant2_score }}</strong>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
